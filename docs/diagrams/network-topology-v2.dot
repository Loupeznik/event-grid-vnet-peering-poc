digraph azure_core_topology {
    # Graph settings
    rankdir=TB;
    ranksep=1.2;
    nodesep=1.0;
    splines=polyline;
    fontname="Arial";
    fontsize=14;
    compound=true;

    # Title
    labelloc="t";
    label="Azure Event Grid VNET Peering PoC\nCore Infrastructure & Traffic Flow";
    fontsize=18;
    fontname="Arial Bold";

    # Node styles
    node [shape=box, style="rounded,filled", fontname="Arial", fontsize=11];
    edge [fontname="Arial", fontsize=10];

    # ============================================================================
    # SUBSCRIPTION 1
    # ============================================================================
    subgraph cluster_sub1 {
        label="Subscription 1\n6391aa55-ec4d-40af-bc22-2e7ad5b7eda5";
        style="filled,bold";
        color="#E3F2FD";
        fontsize=14;
        fontname="Arial Bold";
        penwidth=3;

        # VNET 1 - Python Function
        subgraph cluster_vnet1 {
            label="VNET 1: vnet-function-*\n10.0.0.0/16";
            style="filled,bold";
            color="#90CAF9";
            fontsize=12;
            penwidth=2;

            subnet1 [label="Subnet: snet-function\n10.0.1.0/24\nDelegation: Microsoft.Web/serverFarms\nNSG: None", shape=box, fillcolor="#BBDEFB"];

            python_func [label="Azure Function App\nfunc-eventgrid-*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nRuntime: Python 3.11\nVNET Integration: ‚úì\nvnetRouteAllEnabled: true\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nFunctions:\n‚Ä¢ publish_event (HTTP)\n‚Ä¢ consume_event (Event Grid)", fillcolor="#4CAF50", fontcolor="white", shape=component, penwidth=2];

            subnet1 -> python_func [style=dashed, color="#666666", label="integrated"];
        }

        # VNET 2 - Event Grid & Event Hub
        subgraph cluster_vnet2 {
            label="VNET 2: vnet-eventgrid-*\n10.1.0.0/16";
            style="filled,bold";
            color="#90CAF9";
            fontsize=12;
            penwidth=2;

            subnet2 [label="Private Endpoint Subnet\n10.1.1.0/27\nNSG: None\nRoute Table: None", shape=box, fillcolor="#BBDEFB"];

            # Private Endpoints
            eg_pe [label="Private Endpoint\npe-eventgrid-*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nPrivate IP: 10.1.1.4\nConnection State: Approved", fillcolor="#FFD700", fontcolor="black", shape=hexagon, penwidth=2];

            eh_pe [label="Private Endpoint\npe-eventhub-*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nPrivate IP: 10.1.1.5\nConnection State: Approved", fillcolor="#FFD700", fontcolor="black", shape=hexagon, penwidth=2];

            subnet2 -> eg_pe [style=dashed, color="#666666", label="contains"];
            subnet2 -> eh_pe [style=dashed, color="#666666", label="contains"];
        }

        # Event Grid (PaaS)
        eventgrid [label="Event Grid Topic\nevgt-poc-*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nPublic Network Access: Disabled\nPrivate Endpoint Only: ‚úì\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nEvent Subscriptions:\n1. func-python-sub ‚Üí Python Function\n2. eventgrid-to-eventhub ‚Üí Event Hub", fillcolor="#2196F3", fontcolor="white", shape=doubleoctagon, penwidth=2];

        # Event Hub (PaaS)
        eventhub [label="Event Hub Namespace\nevhns-eventgrid-*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nEvent Hub: events\nPartitions: 2\nPublic Network Access: Disabled\nPrivate Endpoint Only: ‚úì", fillcolor="#2196F3", fontcolor="white", shape=doubleoctagon, penwidth=2];

        # Private DNS
        dns [label="Private DNS Zones\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nprivatelink.eventgrid.azure.net\nprivatelink.servicebus.windows.net\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nLinked to: VNET 1, 2, 3", fillcolor="#9C27B0", fontcolor="white", shape=cylinder];

        # Connections within Sub 1
        eventgrid -> eg_pe [label="attached to", dir=none, color="#2196F3", penwidth=2];
        eventhub -> eh_pe [label="attached to", dir=none, color="#2196F3", penwidth=2];
    }

    # ============================================================================
    # SUBSCRIPTION 2
    # ============================================================================
    subgraph cluster_sub2 {
        label="Subscription 2\n4f120dcf-daee-4def-b87c-4139995ca024";
        style="filled,bold";
        color="#E8F5E9";
        fontsize=14;
        fontname="Arial Bold";
        penwidth=3;

        # VNET 3 - .NET Function
        subgraph cluster_vnet3 {
            label="VNET 3: vnet-dotnet-*\n10.2.0.0/16";
            style="filled,bold";
            color="#81C784";
            fontsize=12;
            penwidth=2;

            subnet3 [label="Subnet: snet-dotnet-function\n10.2.1.0/24\nDelegation: Microsoft.Web/serverFarms\nNSG: None", shape=box, fillcolor="#C8E6C9"];

            dotnet_func [label="Azure Function App\nfunc-dotnet-*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nRuntime: .NET 10 (isolated)\nVNET Integration: ‚úì\nvnetRouteAllEnabled: true\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nFunctions:\n‚Ä¢ PublishEvent (HTTP)\n‚Ä¢ ConsumeEvent (Event Grid)\n‚Ä¢ ConsumeEventFromEventHub", fillcolor="#4CAF50", fontcolor="white", shape=component, penwidth=2];

            subnet3 -> dotnet_func [style=dashed, color="#666666", label="integrated"];
        }
    }

    # ============================================================================
    # VNET PEERING
    # ============================================================================

    # Peering within Subscription 1
    subnet1 -> subnet2 [label="VNET Peering\npeer-function-to-eventgrid\n‚Üï\npeer-eventgrid-to-function\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nState: Connected\nAllowForwardedTraffic: true", color="#2196F3", penwidth=3, style=bold, dir=both];

    # Cross-Subscription Peering
    subnet2 -> subnet3 [label="Cross-Subscription\nVNET Peering\npeer-eventgrid-to-dotnet (Sub1)\n‚Üï\npeer-dotnet-to-eventgrid (Sub2)\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nState: Connected\nAllowForwardedTraffic: true", color="#4CAF50", penwidth=3, style=bold, dir=both];

    # ============================================================================
    # DNS RESOLUTION
    # ============================================================================

    dns -> python_func [label="DNS resolution\n(VNET link)", style=dashed, color="#9C27B0"];
    dns -> dotnet_func [label="DNS resolution\n(VNET link)", style=dashed, color="#9C27B0"];

    # ============================================================================
    # TRAFFIC FLOWS - FULLY PRIVATE (EVENT HUB PATH)
    # ============================================================================

    # Flow 1: .NET publishes to Event Grid
    dotnet_func -> eg_pe [label="‚ë†  HTTP POST\nPublish Event\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nPath: 10.2.x.x ‚Üí 10.1.1.4\nAuth: Managed Identity\nDNS: privatelink.eventgrid.azure.net\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nFULLY PRIVATE (VNET peering)", color="#4CAF50", penwidth=3, fontcolor="#2E7D32", fontsize=11];

    # Flow 2: Event Grid to Event Hub
    eventgrid -> eventhub [label="‚ë°  Event Delivery\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nEvent Grid ‚Üí Event Hub\nAuth: System Managed Identity\nProtocol: AMQP\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nFULLY PRIVATE (Azure backbone)", color="#4CAF50", penwidth=3, fontcolor="#2E7D32", fontsize=11];

    # Flow 3: .NET consumes from Event Hub
    eh_pe -> dotnet_func [label="‚ë¢  Poll/Consume\nEvent Hub Trigger\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nPath: 10.1.1.5 ‚Üí 10.2.x.x\nAuth: Managed Identity\nDNS: privatelink.servicebus.windows.net\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nFULLY PRIVATE (VNET peering)", color="#4CAF50", penwidth=3, fontcolor="#2E7D32", fontsize=11];

    # ============================================================================
    # TRAFFIC FLOWS - WEBHOOK (COMPARISON)
    # ============================================================================

    # Flow 4: Python publishes to Event Grid
    python_func -> eg_pe [label="HTTP POST\nPublish Event\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nPath: 10.0.x.x ‚Üí 10.1.1.4\nAuth: Managed Identity\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nPRIVATE (VNET peering)", color="#FF9800", penwidth=2, fontcolor="#E65100", fontsize=10];

    # Flow 5: Event Grid webhook to Python
    eventgrid -> python_func [label="Webhook Delivery\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nEvent Grid ‚Üí Python Function\nProtocol: HTTPS (webhook)\nIP Restrictions: AzureEventGrid tag\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nPUBLIC (Azure backbone)", color="#F44336", penwidth=2, fontcolor="#C62828", fontsize=10, style=dashed];

    # ============================================================================
    # LEGEND
    # ============================================================================

    subgraph cluster_legend {
        label="Legend";
        style=filled;
        color="#FFFFFF";
        fontsize=12;
        rank=sink;

        legend_private [label="üü¢ Fully Private Path\n(VNET peering)", fillcolor="#4CAF50", fontcolor="white", penwidth=2];
        legend_hybrid [label="üü† Publish: Private\nüî¥ Delivery: Public (webhook)", fillcolor="#FF9800", fontcolor="white"];
        legend_pe [label="Private Endpoint\n(10.1.1.x)", fillcolor="#FFD700", fontcolor="black", shape=hexagon];
        legend_paas [label="PaaS Service", fillcolor="#2196F3", fontcolor="white", shape=doubleoctagon];
        legend_func [label="Function App", fillcolor="#4CAF50", fontcolor="white", shape=component];
        legend_vnet [label="VNET / Subnet", fillcolor="#90CAF9", fontcolor="black", shape=box];

        legend_private -> legend_hybrid [style=invis];
        legend_hybrid -> legend_pe [style=invis];
        legend_pe -> legend_paas [style=invis];
        legend_paas -> legend_func [style=invis];
        legend_func -> legend_vnet [style=invis];
    }

    # Notes
    note [label="‚úÖ Event Hub Path: 100% Private\n(No public internet at any point)\n\n‚ö†Ô∏è  Webhook Path: Hybrid\n(Private publish, public delivery)", shape=note, fillcolor="#FFEB3B", fontcolor="black", penwidth=2, fontsize=11];
}
